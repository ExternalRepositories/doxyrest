#!/bin/bash
#...............................................................................
#
#  This file is part of the Doxyrest toolkit.
#
#  Doxyrest is distributed under the MIT license.
#  For details see accompanying license.txt file,
#  the public copy of which is also available at:
#  http://tibbo.com/downloads/archive/doxyrest/license.txt
#
#...............................................................................

set -e

ROOT_DIR=${DOXYREST_ROOT_DIR}
BIN_DIR=${DOXYREST_BIN_BASE_DIR}/${CONFIGURATION_SUFFIX}
OUT_DIR=${DOXYREST_PACKAGE_DIR}
TAR_DIR=${CMAKE_CURRENT_BINARY_DIR}/tar
TAR_SUB_DIR=doxyrest-${DOXYREST_VERSION_FILE_SUFFIX}
CONTENTS_DIR=$TAR_DIR/$TAR_SUB_DIR

# detect OS

_S=$(uname -s)
case "$_S" in
"Linux")
	TARGET_OS=linux
	;;

"Darwin")
	TARGET_OS=mac
	;;

*)
	echo "Unsupported OS: \"$_S\""
	exit -1
esac

if [ "$TARGET_OS" == "mac" ]; then
	OUT_FILE_NAME=doxyrest-mac-${DOXYREST_VERSION_FILE_SUFFIX}.tar.xz
else
	OUT_FILE_NAME=doxyrest-$TARGET_OS-${DOXYREST_VERSION_FILE_SUFFIX}-${AXL_CPU}.tar.xz
fi

OUT_FILE_PATH=$OUT_DIR/$OUT_FILE_NAME

echo Building archive $OUT_FILE_NAME...

rm -rf $TAR_DIR
rm -f $OUT_FILE_PATH

mkdir -p $CONTENTS_DIR/bin
mkdir -p $CONTENTS_DIR/cmake
mkdir -p $CONTENTS_DIR/frame
mkdir -p $CONTENTS_DIR/license
mkdir -p $CONTENTS_DIR/sphinx
mkdir -p $OUT_DIR

cp -f $BIN_DIR/doxyrest $CONTENTS_DIR/bin
cp -f $ROOT_DIR/package/cmake/*.* $CONTENTS_DIR/cmake
cp -f $ROOT_DIR/cmake/import_doxyrest.cmake $CONTENTS_DIR/cmake
cp -f $ROOT_DIR/version.cmake $CONTENTS_DIR/cmake
cp -rf $ROOT_DIR/frame $CONTENTS_DIR
cp -rf $ROOT_DIR/license $CONTENTS_DIR
cp -f $ROOT_DIR/sphinx/*.py $CONTENTS_DIR/sphinx
cp -f $ROOT_DIR/sphinx/*.sty $CONTENTS_DIR/sphinx

if [ -d $ROOT_DIR/samples ]; then
	cp -rf $ROOT_DIR/samples $CONTENTS_DIR
fi

chown -R root:$(id -gn root) $TAR_DIR
tar -cJf $OUT_FILE_PATH -C $TAR_DIR $TAR_SUB_DIR
rm -rf $TAR_DIR
